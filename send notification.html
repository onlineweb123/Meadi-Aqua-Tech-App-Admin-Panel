<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Send Notification | Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #0077b6; 
            --success: #10b981;
            --bg: #f0f4f8; 
            --card: #ffffff; 
            --border: #e2e8f0; 
            --text-dark: #0f172a;
            --text-light: #64748b;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            padding: 20px; 
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0;
        }

        .container { 
            max-width: 500px; width: 100%;
            background: var(--card); padding: 30px; 
            border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }

        h2 { color: var(--primary); text-align: center; margin-bottom: 10px; font-weight: 800; }
        p { text-align: center; color: var(--text-light); font-size: 14px; margin-bottom: 25px; }

        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }

        input, textarea { 
            width: 100%; padding: 14px; 
            border: 2px solid var(--border); border-radius: 12px; 
            outline: none; font-family: inherit; background: #f8fafc;
        }

        input:focus, textarea:focus { border-color: var(--primary); background: #fff; }

        .btn { 
            border: none; border-radius: 12px; cursor: pointer; 
            font-weight: 700; display: flex; align-items: center; 
            justify-content: center; gap: 10px;
        }

        .btn-search { background: var(--primary); color: white; padding: 0 20px; }
        .btn-send { background: var(--success); color: white; width: 100%; padding: 15px; font-size: 16px; margin-top: 10px;}

        /* Current Message Preview Style */
        .msg-preview-box {
            background: #fff; border: 1px dashed var(--border);
            padding: 12px; border-radius: 12px; margin-top: 10px;
            display: none; position: relative;
        }
        .delete-msg-btn {
            position: absolute; top: 8px; right: 8px;
            background: #fee2e2; color: var(--danger);
            border: none; border-radius: 6px; padding: 4px 8px;
            cursor: pointer; font-size: 12px; font-weight: 700;
        }

        .user-info-box {
            background: #e0f2fe; padding: 15px; border-radius: 12px;
            margin-bottom: 15px; display: none; border-left: 5px solid var(--primary);
        }

        .label-tag { font-size: 10px; color: var(--primary); font-weight: 800; text-transform: uppercase; display: block;}
        .user-detail-row { font-size: 14px; margin-bottom: 8px; }

        .status { margin-top: 15px; font-size: 13px; text-align: center; font-weight: 600; padding: 10px; border-radius: 8px; display: none; }
        
        .spinner {
            display: none; width: 18px; height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading .btn-text { display: none; }
        .loading .spinner { display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>üîî Admin Notifier</h2>
    <p>‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡Æø ‡Æ§‡Æï‡Æµ‡Æ≤‡Øç ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æµ‡ØÅ‡ÆÆ‡Øç</p>
    
    <label class="label-tag">SEARCH CUSTOMER</label>
    <div class="input-group">
        <input type="text" id="searchInput" placeholder="Username or Phone No">
        <button class="btn btn-search" id="searchBtn">
            <span class="btn-text">üîç Search</span>
            <div class="spinner"></div>
        </button>
    </div>

    <div id="userInfo" class="user-info-box">
        <div class="user-detail-row">
            <span class="label-tag">Name</span> 
            <span id="dispName" style="font-weight: 700;">-</span>
        </div>
        <div class="user-detail-row">
            <span class="label-tag">Phone</span> 
            <span id="dispPhone" style="font-weight: 700; color: #0369a1;">-</span>
        </div>

        <div id="currentMsgBox" class="msg-preview-box">
            <button class="delete-msg-btn" id="deleteMsgBtn">üóë Clear Sent</button>
            <span class="label-tag">LAST SENT MESSAGE</span>
            <div id="dispLastMsg" style="font-size: 13px; color: #1e293b; font-weight: 600; margin-top: 5px;">-</div>
            <div id="dispLastTime" style="font-size: 10px; color: var(--text-light); margin-top: 3px;">-</div>
        </div>
    </div>

    <label class="label-tag">NEW MESSAGE</label>
    <textarea id="notifMessage" rows="3" placeholder="‡Æá‡Æô‡Øç‡Æï‡Øá ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æ§‡Æï‡Æµ‡Æ≤‡Øà ‡Æ§‡Æü‡Øç‡Æü‡Æö‡Øç‡Æö‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç..."></textarea>
    
    <button class="btn btn-send" id="sendBtn">
        <span class="btn-text">üöÄ Send Message</span>
        <div class="spinner"></div>
    </button>

    <div id="status" class="status"></div>
    
    <br>
    <a href="admin.html" style="display:block; text-align:center; color: var(--primary); text-decoration: none; font-size: 14px; font-weight: 600;">‚Üê Back to Dashboard</a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, update, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqyyGJt_t0ztknMudFVLmo6relkEa284g",
        authDomain: "meadi-aqua-tech.firebaseapp.com",
        databaseURL: "https://meadi-aqua-tech-default-rtdb.firebaseio.com",
        projectId: "meadi-aqua-tech",
        storageBucket: "meadi-aqua-tech.firebasestorage.app",
        messagingSenderId: "531151217708",
        appId: "1:531151217708:web:b30b6e1a0bf7fa60f29d89",
        measurementId: "G-QW495L6JVE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let activeTargetUsername = "";

    function setBtnLoading(btnId, isLoading) {
        const btn = document.getElementById(btnId);
        if (isLoading) btn.classList.add('loading');
        else btn.classList.remove('loading');
    }

    function showStatus(msg, isError = false) {
        const statusDiv = document.getElementById('status');
        statusDiv.style.display = "block";
        statusDiv.style.color = isError ? "#ef4444" : "#10b981";
        statusDiv.style.background = isError ? "#fee2e2" : "#d1fae5";
        statusDiv.innerText = msg;
    }

    // --- Search Logic ---
    document.getElementById('searchBtn').onclick = async () => {
        const input = document.getElementById('searchInput').value.trim();
        if(!input) return alert("Please enter Username or Phone Number");

        setBtnLoading('searchBtn', true);
        const dbRef = ref(db);

        try {
            const snapshot = await get(child(dbRef, `users`));
            if (snapshot.exists()) {
                const users = snapshot.val();
                let foundKey = "";

                for (let key in users) {
                    if (key.toLowerCase() === input.toLowerCase() || users[key].phone === input) {
                        foundKey = key;
                        break;
                    }
                }

                if (foundKey) {
                    activeTargetUsername = foundKey;
                    const userData = users[foundKey];
                    
                    document.getElementById('userInfo').style.display = "block";
                    document.getElementById('dispName').innerText = userData.name || "N/A";
                    document.getElementById('dispPhone').innerText = userData.phone || "N/A";

                    // ‡Æè‡Æ±‡Øç‡Æï‡Æ©‡Æµ‡Øá ‡ÆÆ‡ØÜ‡Æö‡Øá‡Æú‡Øç ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç ‡ÆÖ‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø
                    if(userData.adminMessage) {
                        document.getElementById('currentMsgBox').style.display = "block";
                        document.getElementById('dispLastMsg').innerText = userData.adminMessage;
                        document.getElementById('dispLastTime').innerText = "Sent at: " + (userData.msgTimestamp || "N/A");
                    } else {
                        document.getElementById('currentMsgBox').style.display = "none";
                    }
                    
                    showStatus("‚úÖ Customer Found!");
                } else {
                    activeTargetUsername = "";
                    document.getElementById('userInfo').style.display = "none";
                    showStatus("‚ùå User not found!", true);
                }
            }
        } catch (e) { alert("Error connecting to Database!"); }
        finally { setBtnLoading('searchBtn', false); }
    };

    // --- Delete Last Message Logic ---
    document.getElementById('deleteMsgBtn').onclick = async () => {
        if(!activeTargetUsername) return;
        if(confirm("Are you sure to delete this sent message?")) {
            try {
                await update(ref(db, `users/${activeTargetUsername}`), {
                    adminMessage: null,
                    msgTimestamp: null
                });
                document.getElementById('currentMsgBox').style.display = "none";
                showStatus("üóë Message deleted successfully");
            } catch (e) { alert("Delete failed!"); }
        }
    };

    // --- Send Logic ---
    document.getElementById('sendBtn').onclick = async () => {
        const msg = document.getElementById('notifMessage').value.trim();
        if(!activeTargetUsername) return alert("Please search for a customer first!");
        if(!msg) return alert("Message cannot be empty!");

        setBtnLoading('sendBtn', true);

        try {
            const timeNow = new Date().toLocaleString();
            await update(ref(db, `users/${activeTargetUsername}`), {
                adminMessage: msg,
                msgTimestamp: timeNow
            });
            
            showStatus("‚úÖ Message sent successfully!");
            // Update the preview immediately
            document.getElementById('currentMsgBox').style.display = "block";
            document.getElementById('dispLastMsg').innerText = msg;
            document.getElementById('dispLastTime').innerText = "Sent at: " + timeNow;
            document.getElementById('notifMessage').value = "";
        } catch (e) { showStatus("‚ùå Failed to send!", true); }
        finally { setBtnLoading('sendBtn', false); }
    };
</script>
</body>
</html>
