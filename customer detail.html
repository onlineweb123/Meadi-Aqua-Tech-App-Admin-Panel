<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Full Details | Meadi Aqua Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #0077b6; 
            --bg: #f4f7fa; 
            --card: #ffffff; 
            --border: #e2e8f0; 
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; padding: 20px;
        }

        .container { max-width: 800px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: var(--primary); margin: 0; }

        .search-card {
            background: var(--card);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .search-box { 
            display: flex; 
            flex-direction: row; 
            gap: 10px; 
            margin-top: 15px;
            width: 100%;
        }
        
        input { 
            flex: 1; 
            min-width: 0;
            padding: 14px; 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            font-size: 15px; 
            outline: none;
        }
        
        input:focus { border-color: var(--primary); }

        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 25px; border-radius: 12px; cursor: pointer;
            font-weight: 700; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
            white-space: nowrap;
        }

        .btn:disabled { background: var(--text-sub); cursor: not-allowed; }

        .spinner {
            width: 18px; height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .detail-card {
            background: var(--card); border-radius: 24px;
            border: 1px solid var(--border); display: none;
            overflow: hidden; animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-header { 
            background: var(--primary); color: white; 
            padding: 20px; text-align: center; 
        }

        .section { padding: 25px; border-bottom: 1px solid #f1f5f9; }
        .section-title { 
            font-size: 14px; color: var(--primary); 
            font-weight: 800; text-transform: uppercase; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-item { display: flex; flex-direction: column; }
        .full-width { grid-column: span 2; }
        .label { font-size: 12px; color: var(--text-sub); font-weight: 600; }
        .value { font-size: 15px; font-weight: 700; color: var(--text-main); margin-top: 4px; }

        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .history-table th { text-align: left; padding: 10px; font-size: 12px; color: var(--text-sub); border-bottom: 1px solid var(--border); }
        .history-table td { padding: 12px 10px; border-bottom: 1px solid #f8fafc; font-size: 14px; }

        .no-data { text-align: center; padding: 40px; color: var(--text-sub); display: none; }

        @media (max-width: 480px) {
            .info-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üîç Customer Explorer</h1>
        <p>Search by Username or Phone</p>
    </div>

    <div class="search-card">
        <label style="font-weight: 700; font-size: 13px;">ENTER USERNAME OR PHONE NUMBER:</label>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search...">
            <button class="btn" id="searchBtn">
                <div class="spinner" id="btnSpinner"></div>
                <span id="btnText">Search</span>
            </button>
        </div>
    </div>

    <div id="noData" class="no-data">‚ùå No customer records found!</div>

    <div id="detailCard" class="detail-card">
        <div class="card-header">
            <h2 id="detName" style="margin:0">---</h2>
            <span id="detUser" style="opacity: 0.8; font-size: 14px;">@username</span>
        </div>

        <div class="section">
            <div class="section-title">üì± Contact Information</div>
            <div class="info-grid">
                <div class="info-item"><span class="label">Phone Number</span><span class="value" id="detPhone">---</span></div>
                <div class="info-item"><span class="label">City</span><span class="value" id="detCity">---</span></div>
                <div class="info-item full-width"><span class="label">Address</span><span class="value" id="detAddress">Not Available</span></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üíß Machine Details</div>
            <div class="info-grid">
                <div class="info-item"><span class="label">Model</span><span class="value" id="detModel">---</span></div>
                <div class="info-item"><span class="label">Installed Date</span><span class="value" id="detInstalled">---</span></div>
                <div class="info-item"><span class="label">Warranty</span><span class="value" id="detWarranty">---</span></div>
                <div class="info-item"><span class="label">AMC Status</span><span class="value" id="detAMC">---</span></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üìú Service History</div>
            <table class="history-table">
                <thead>
                    <tr><th>Service Type</th><th>Date</th></tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
        
        <div style="padding: 20px;">
            <button class="btn" style="width: 100%; background: #64748b;" onclick="window.print()">üñ® Print Details</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqyyGJt_t0ztknMudFVLmo6relkEa284g",
        authDomain: "meadi-aqua-tech.firebaseapp.com",
        databaseURL: "https://meadi-aqua-tech-default-rtdb.firebaseio.com",
        projectId: "meadi-aqua-tech",
        storageBucket: "meadi-aqua-tech.firebasestorage.app",
        messagingSenderId: "531151217708",
        appId: "1:531151217708:web:b30b6e1a0bf7fa60f29d89",
        measurementId: "G-QW495L6JVE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const btnSpinner = document.getElementById('btnSpinner');
    const btnText = document.getElementById('btnText');

    async function fetchCustomer() {
        const query = searchInput.value.trim();
        if(!query) return;

        searchBtn.disabled = true;
        btnSpinner.style.display = "block";
        btnText.innerText = "Searching...";

        const dbRef = ref(db);
        const detailCard = document.getElementById('detailCard');
        const noData = document.getElementById('noData');

        try {
            const allUsersSnap = await get(child(dbRef, 'users'));
            
            if (allUsersSnap.exists()) {
                const allUsers = allUsersSnap.val();
                let foundUser = null;
                let foundKey = "";

                for (let key in allUsers) {
                    if (key.toLowerCase() === query.toLowerCase() || allUsers[key].phone === query) {
                        foundUser = allUsers[key];
                        foundKey = key;
                        break;
                    }
                }

                if (foundUser) {
                    showDetails(foundUser, foundKey);
                } else {
                    detailCard.style.display = 'none';
                    noData.style.display = 'block';
                }
            } else {
                noData.style.display = 'block';
            }
        } catch (e) {
            console.error(e);
            alert("Database Error!");
        } finally {
            searchBtn.disabled = false;
            btnSpinner.style.display = "none";
            btnText.innerText = "Search";
        }
    }

    function showDetails(user, username) {
        document.getElementById('noData').style.display = 'none';
        document.getElementById('detailCard').style.display = 'block';

        document.getElementById('detName').innerText = user.name || "N/A";
        document.getElementById('detUser').innerText = "@" + username;
        document.getElementById('detPhone').innerText = user.phone || "N/A";
        document.getElementById('detCity').innerText = user.city || "N/A";
        // Restored Mapping
        document.getElementById('detAddress').innerText = user.address || "Not Available";
        
        document.getElementById('detModel').innerText = user.model || "Not Set";
        document.getElementById('detInstalled').innerText = user.installed || "Not Set";
        document.getElementById('detWarranty').innerText = user.warranty || "N/A";
        document.getElementById('detAMC').innerText = user.lastAMCDate ? "Active" : "No Plan";

        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = "";
        const history = user.history ? (Array.isArray(user.history) ? user.history : Object.values(user.history)) : [];

        if(history.length > 0) {
            history.forEach(item => {
                tbody.innerHTML += `<tr><td><b>${item.type}</b></td><td>${item.date}</td></tr>`;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">No records.</td></tr>';
        }
    }

    searchBtn.onclick = fetchCustomer;
    searchInput.onkeypress = (e) => { if(e.key === "Enter") fetchCustomer(); };
</script>
</body>
</html>
