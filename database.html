<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Diary | Meadi Aqua Tech</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --bg: #f4f7fa; --card: #ffffff; --border: #e2e8f0; --primary: #0077b6; 
            --text-main: #1e293b; --text-sub: #64748b; --success: #10b981; --danger: #ef4444;
            --sidebar-w: 220px;
        }

        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); height: 100vh; overflow: hidden; }
        
        .sidebar { 
            position: fixed; top: 0; left: calc(-1 * var(--sidebar-w)); 
            width: var(--sidebar-w); height: 100%; background: white; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000;
            transition: 0.3s ease; display: flex; flex-direction: column;
        }
        .sidebar.open { left: 0; }

        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 999; display: none;
        }
        .overlay.active { display: block; }

        .sidebar-header { 
            padding: 20px 15px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            position: relative;
        }
        .year-select { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--primary); font-weight: 700; color: var(--primary); outline: none; background: white; }
        
        .month-list { flex: 1; overflow-y: auto; padding: 10px; }
        .month-item { 
            padding: 12px; margin-bottom: 5px; border-radius: 8px; font-size: 14px; 
            cursor: pointer; color: var(--text-sub); font-weight: 600; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .month-item.active { background: #e0f2fe; color: var(--primary); }
        
        /* Loading Spinner */
        .spinner {
            width: 18px; height: 18px; border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none;
            position: relative; z-index: 1001;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .day-list-sidebar { padding-left: 15px; display: none; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .day-item-sidebar { 
            padding: 8px 12px; font-size: 13px; color: var(--text-sub); 
            cursor: pointer; border-radius: 6px; border-left: 2px solid #e2e8f0;
        }
        .day-item-sidebar:hover { background: #f8fafc; color: var(--primary); }
        .day-item-sidebar.active { border-left-color: var(--primary); color: var(--primary); font-weight: 700; background: #f0f9ff; }

        .content { width: 100%; height: 100%; display: flex; flex-direction: column; }
        
        header { 
            height: 65px; display: flex; align-items: center; justify-content: center; 
            padding: 0 15px; background: white; border-bottom: 1px solid var(--border); position: relative;
        }
         
        .menu-btn { 
            position: absolute; left: 15px; font-size: 24px; 
            background: #f1f5f9; border: none; color: var(--text-main); 
            cursor: pointer; width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .header-title { font-size: 18px; font-weight: 700; color: var(--primary); letter-spacing: -0.5px; }

        .main-scroll { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }

        .summary-bar { 
            background: #1e293b; color: white; padding: 15px; border-radius: 15px; 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;
            font-size: 11px; font-weight: 600; margin-bottom: 15px; text-align: center;
        }
        .summary-val { font-size: 14px; margin-top: 4px; display: block; }

        .chart-container {
            background: white; border-radius: 20px; border: 1px solid var(--border);
            padding: 15px; margin-bottom: 20px; height: 220px; 
        }

        .db-card { background: white; border-radius: 20px; border: 1px solid var(--border); overflow: hidden; }
        .db-item { padding: 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .info-part { display: flex; flex-direction: column; gap: 3px; }
        .cust-name { font-weight: 700; font-size: 15px; }
        .purpose { font-size: 12px; color: var(--text-sub); }
        .time { font-size: 10px; color: #94a3b8; }
        .amt-val { font-weight: 800; font-size: 15px; }
        
        .bottom {
            height: 75px; position: fixed; bottom: 0; left: 0; right: 0; 
            display: flex; justify-content: space-around; align-items: center; 
            background: white; border-top: 1px solid var(--border); z-index: 100;
        }
        .bottom button { background: none; border: none; font-size: 11px; font-weight: 600; display: flex; flex-direction: column; align-items: center; color: var(--text-sub); cursor: pointer; }
        .bottom button.active { color: var(--primary); }
        .bottom .icon { font-size: 22px; margin-bottom: 4px; }
        
    </style>
</head>
<body>

<div class="overlay" id="overlay"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <select id="yearSelect" class="year-select" onclick="showYearLoader()"></select>
        <div class="spinner" id="yearSpinner"></div>
    </div>
    <div class="month-list" id="monthList"></div>
</div>

<div class="content">
    <header>
        <div class="menu-btn" id="menuBtn">‚ò∞</div>
        <div class="header-title" id="headerTitle">Diary Database</div>
        <div id="activeDateDisplay" style="position: absolute; right: 15px; font-size: 10px; color: var(--text-sub); font-weight: 700;"></div>
    </header>

    <div class="main-scroll">
        <div class="summary-bar" id="topSummary">
            <div><span>Income</span><span class="summary-val" id="sumIn">‚Çπ0</span></div>
            <div><span>Expense</span><span class="summary-val" id="sumOut">‚Çπ0</span></div>
            <div><span>Balance</span><span class="summary-val" id="sumBal">‚Çπ0</span></div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>

        <div class="db-card" id="diaryContainer">
            <p id="initMessage" style="text-align:center; padding: 50px; color: var(--text-sub);">Please select a month from the menu (‚ò∞)</p>
        </div>
    </div>

    <div class="bottom">
        <button onclick="location.href='index.html'"><span class="icon">üè†</span>Home</button>
        <button onclick="location.href='service.html'"><span class="icon">‚öíÔ∏è</span>Service</button>
        <button onclick="location.href='store.html'"><span class="icon">üõí</span>Store</button>
        <button onclick="location.href='profile.html'"><span class="icon">üë§</span>Profile</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqyyGJt_t0ztknMudFVLmo6relkEa284g",
        authDomain: "meadi-aqua-tech.firebaseapp.com",
        databaseURL: "https://meadi-aqua-tech-default-rtdb.firebaseio.com",
        projectId: "meadi-aqua-tech"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const user = localStorage.getItem("aquaUser") || "Guest";

    let allData = [];
    let myChartInstance = null;
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const menuBtn = document.getElementById("menuBtn");
    const yearSelect = document.getElementById("yearSelect");
    const yearSpinner = document.getElementById("yearSpinner");

    const toggleSidebar = () => {
        sidebar.classList.toggle("open");
        overlay.classList.toggle("active");
    };

    menuBtn.onclick = toggleSidebar;
    overlay.onclick = toggleSidebar;

    const mList = document.getElementById("monthList");
    months.forEach((m, i) => {
        const mm = `/${String(i + 1).padStart(2, '0')}/`;
        const monthId = `month-${i}`;
        mList.innerHTML += `
            <div class="month-group">
                <div class="month-item" id="${monthId}" onclick="toggleMonthDays('${mm}', '${monthId}')">
                    ${m} <span class="arrow">‚ñæ</span>
                    <div class="spinner" id="spinner-${monthId}"></div>
                </div>
                <div class="day-list-sidebar" id="days-for-${monthId}"></div>
            </div>`;
    });

    // Function to show loader when year is touched
    window.showYearLoader = () => {
        yearSpinner.style.display = "block";
        // Hide it after a short delay if no change happens, or onchange will handle it
        setTimeout(() => { if(yearSpinner.style.display === "block") yearSpinner.style.display = "none"; }, 2000);
    };

    // Firebase load logic with loader
    yearSpinner.style.display = "block";
    onValue(ref(db, `users/${user}/transactions`), (snapshot) => {
        if (snapshot.exists()) {
            allData = Object.keys(snapshot.val()).map(key => ({ id: key, ...snapshot.val()[key] }));
            updateYearList();
        }
        yearSpinner.style.display = "none";
    });

    function updateYearList() {
        const currentYear = new Date().getFullYear().toString();
        const availableYears = [...new Set(allData.map(item => {
            const parts = item.date.split('/');
            return parts[parts.length - 1].split(',')[0].trim();
        }))];
        if (!availableYears.includes(currentYear)) availableYears.push(currentYear);
        availableYears.sort((a, b) => b - a);
        yearSelect.innerHTML = "";
        availableYears.forEach(yr => {
            const opt = document.createElement("option");
            opt.value = yr; opt.innerText = yr;
            if (yr === currentYear) opt.selected = true;
            yearSelect.appendChild(opt);
        });
    }

    yearSelect.onchange = () => {
        yearSpinner.style.display = "block";
        document.querySelectorAll('.day-list-sidebar').forEach(el => el.style.display = 'none');
        setTimeout(() => { yearSpinner.style.display = "none"; }, 800);
    };

    window.toggleMonthDays = (mm, monthId) => {
        const dayListDiv = document.getElementById(`days-for-${monthId}`);
        const spinner = document.getElementById(`spinner-${monthId}`);
        const arrow = document.querySelector(`#${monthId} .arrow`);
        const selectedYear = yearSelect.value;

        if (dayListDiv.style.display === 'flex') {
            dayListDiv.style.display = 'none';
            arrow.style.display = 'inline';
            return;
        }

        document.querySelectorAll('.day-list-sidebar').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.arrow').forEach(el => el.style.display = 'inline');
        
        arrow.style.display = 'none';
        spinner.style.display = 'block';

        setTimeout(() => {
            const monthData = allData.filter(d => d.date.includes(mm) && d.date.includes(selectedYear));
            updateGraph(monthData); 
            displayList(monthData); 

            const days = [...new Set(monthData.map(d => d.date.split('/')[0]))].sort((a,b) => b-a);
            dayListDiv.innerHTML = "";
            if(days.length > 0) {
                days.forEach(day => {
                    dayListDiv.innerHTML += `<div class="day-item-sidebar" onclick="selectDay('${day}', '${mm}', '${selectedYear}', this)">Date: ${day}</div>`;
                });
            } else {
                dayListDiv.innerHTML = `<div style="padding:10px; font-size:11px; color:gray;">No records</div>`;
            }
            
            spinner.style.display = 'none'; 
            arrow.style.display = 'inline';
            dayListDiv.style.display = 'flex';
        }, 500); 
    };

    window.selectDay = (day, mm, yy, el) => {
        document.querySelectorAll('.day-item-sidebar').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        const fullDateStr = `${day}${mm}${yy}`;
        document.getElementById("activeDateDisplay").innerText = fullDateStr;
        const dayData = allData.filter(d => d.date.includes(fullDateStr));
        displayList(dayData);
        toggleSidebar();
    };

    function updateGraph(data) {
        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChartInstance) myChartInstance.destroy();
        if(data.length === 0) { myChartInstance = null; return; }
        const dailyTotals = {};
        data.forEach(item => {
            const day = parseInt(item.date.split('/')[0]);
            if (!dailyTotals[day]) dailyTotals[day] = { inc: 0, exp: 0 };
            if (item.type === 'income') dailyTotals[day].inc += item.amt;
            else dailyTotals[day].exp += item.amt;
        });
        const sortedDays = Object.keys(dailyTotals).sort((a, b) => a - b);
        myChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDays.map(d => "D" + d),
                datasets: [
                    { label: 'Income', data: sortedDays.map(d => dailyTotals[d].inc), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 },
                    { label: 'Expense', data: sortedDays.map(d => dailyTotals[d].exp), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function displayList(data) {
        const container = document.getElementById("diaryContainer");
        container.innerHTML = "";
        let sin = 0; let sout = 0;
        if(data.length === 0) {
            container.innerHTML = "<p style='text-align:center; padding:50px;'>No records found.</p>";
            updateSummary(0, 0); return;
        }
        data.forEach(item => {
            if(item.type === 'income') sin += item.amt; else sout += item.amt;
            container.innerHTML += `
                <div class="db-item">
                    <div class="info-part">
                        <span class="cust-name">${item.customer || 'Internal'}</span>
                        <span class="purpose">${item.desc}</span>
                        <span class="time">üïí ${item.date.split(',')[1]} (${item.date.split('/')[0]})</span>
                    </div>
                    <div><span class="amt-val" style="color:${item.type==='income'?'var(--success)':'var(--danger)'}">‚Çπ${item.amt}</span></div>
                </div>`;
        });
        updateSummary(sin, sout);
    }

    function updateSummary(income, expense) {
        document.getElementById("sumIn").innerText = `‚Çπ${income}`;
        document.getElementById("sumOut").innerText = `‚Çπ${expense}`;
        document.getElementById("sumBal").innerText = `‚Çπ${income - expense}`;
        document.getElementById("sumBal").style.color = (income - expense) >= 0 ? 'var(--success)' : 'var(--danger)';
    }
</script>
</body>
</html>
